# Track upstream k3s-io/kine releases and notify when new versions are available
# This enables the team to cherry-pick IAM-related changes onto new release branches
---
name: "Track upstream kine releases"

scms:
  kine:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: "loft-sh"
      repository: "kine"
      branch: "master"

sources:
  latestUpstreamRelease:
    name: "Get latest upstream kine release"
    kind: "githubrelease"
    spec:
      owner: "k3s-io"
      repository: "kine"
      token: '{{ requiredEnv .github.token }}'
      username: "{{ requiredEnv .github.username }}"
      versionFilter:
        kind: "semver"
        pattern: ">=0.14.0"
      transformers:
        - trimPrefix: "v"

# Only proceed if the tracked version differs from upstream
conditions:
  versionDiffers:
    name: "Check if upstream version differs from tracked version"
    kind: "file"
    sourceid: "latestUpstreamRelease"
    spec:
      file: "updatecli/upstream-kine-version.txt"
    failwhen: true

targets:
  updateTrackedVersion:
    name: "Update tracked upstream kine version"
    kind: "file"
    scmid: "kine"
    sourceid: "latestUpstreamRelease"
    spec:
      file: "updatecli/upstream-kine-version.txt"

actions:
  github:
    kind: "github/pullrequest"
    scmid: "kine"
    title: 'chore: new upstream kine release v{{ source "latestUpstreamRelease" }} available'
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      labels:
        - "upstream-release"
      description: |
        A new upstream kine release is available: **v{{ source "latestUpstreamRelease" }}**

        ## Action Required

        1. Create a new release branch from the upstream tag:
           ```bash
           git fetch upstream --tags
           git checkout -b release-{{ source "latestUpstreamRelease" }} v{{ source "latestUpstreamRelease" }}
           ```

        2. Cherry-pick the IAM authentication commit:
           ```bash
           git cherry-pick fcf4e5a  # Add support for AWS RDS IAM Authentication
           ```

        3. Push and create the loft-sh release:
           ```bash
           git push origin release-{{ source "latestUpstreamRelease" }}
           ```

        ## Upstream Release

        - [k3s-io/kine v{{ source "latestUpstreamRelease" }}](https://github.com/k3s-io/kine/releases/tag/v{{ source "latestUpstreamRelease" }})

        ---
        *This PR was automatically generated by updatecli.*
